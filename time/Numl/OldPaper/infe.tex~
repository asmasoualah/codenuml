
\section{The Type System}
\label{infe}


In our system, expressions and types are mutually dependant. They are defined inductively using the grammar of Equation (\ref{eqsyntax}).
\begin{equation}\label{eqsyntax}
\begin{array}{rcl}
e&::=&\ \mathtt{f}\{u,p\}\in \mathsf{F}_{u,p}\ |\ \mathtt{i}\in \mathsf{I}\ |\ \mathtt{b}\in \mathsf{B}
\ |\ \mathtt{id}\in\mathsf{V} \\
&& |\  \mathtt{if}\ e_0\ \mathtt{then}\ e_1\ \mathtt{else}\ e_2
\ |\ \lambda x.e
\ |\ e_0\ e_1\ |\ t\\
&&\\
t&::=&|\ \mathtt{int}\ |\ \mathtt{bool}\ |\ \F{e_0}{e_1}\ |\ \alpha\ |\ \Pi.x:e_0.e_1\ 
\end{array}
\end{equation}
In Equation (\ref{eqsyntax}), the $e$ terms correspond to statements.
Constants are integers $\mathtt{i}$, booleans $\mathtt{b}$ and floating-point numbers  $\mathtt{f}\{u,p\}$ where $\mathsf{f}$
is the value itself and $u,p\in \mathsf{I}$ the format of $\mathtt{f}$. 
Identifiers are denoted $\mathtt{id}$. The language also admits conditionals, functions $\lambda x.e$ 
and application $e_0\ e_1$.
The $t$ terms of the grammar corresponds to types expressions which are mutually recursive with statements.
The types of constants are $\mathtt{int}$, $\mathtt{bool}$ and $\F{e_0}{e_1}{e_2}$ where $e_0$, $e_1$ and $e_2$ are general expressions
denoting the format of the floating-point number. Type variables are denoted $\alpha$
and $\Pi.x:e_0.e_1$ represents ???. 
Let us note that abstractions  $\lambda x.e$ are defined in the language for convenience. They are syntactic sugar for
$\Pi x.$??????
The arithmetic and logic operators are viewed as functional constants of the language. 


\begin{equation}\label{eqlttype}
\F{s_1}{u_1}{p_1} \sqsubseteq \F{s_2}{u_2}{p_2} \iff s_1\sqsubseteq s_2\ \wedge\ u_2 \ge u_1\ \wedge\ p_2 \ge u_1 - u_2 + p_1
\end{equation}


\begin{figure}[tb]
\hrule
$$
\frac{}
     {\Gamma \vdash \texttt{i} :\ \mathtt{int} }\quad\textsc{(Int)}
	 \hspace{2cm}
\frac{}
     {\Gamma \vdash \texttt{b } :\ \mathtt{bool} }\quad\textsc{(Bool)}
$$
$$
\frac{\mathsf{ufp}(\texttt{f})\le u}
     {\Gamma \vdash \texttt{f\{u,p\}}\ :\ \F{s}{u}{p} }\quad\textsc{(Float)}
\hspace{2cm}
\frac{\mathtt{id} : t \in \Gamma}
     {\Gamma \vdash \mathtt{id}\ :\ t }\quad\textsc{(Var)}
$$
$$
\frac{
\Gamma \vdash e_0\ :\ \mathtt{bool}\hspace{1cm}\Gamma \vdash e_1\ :\ t_1\hspace{1cm} \Gamma \vdash e_2\ :\ t_2
\hspace{1cm} t=t_1\sqcup t_2}
{\Gamma\vdash \mathtt{if}\ e_0\ \mathtt{then}\ e_1\ \mathtt{else}\ e_2\ :\  t}\quad\textsc{(Cond)}
$$
$$
\frac{\Gamma,x :t_1 \vdash e :  t_2}
     {\Gamma \vdash \lambda x.e : \Pi x:t_1 .  t_2}\quad\textsc{(Abs)}
%\hspace{2cm}
$$
$$
\frac{\Gamma \vdash e_1 : \Pi x: t_0. t_1\hspace{1cm} \Gamma \vdash e_2 :  t_2
\hspace{1cm} t_2\sqsubseteq t_1
}
     {\Gamma \vdash e_1\ e_2 :  t_2[x\mapsto e_2]}\quad\textsc{(App)}
$$
\hrule
\caption{\label{figtyp}Inference rules for our type system.} 
\end{figure}

In Rule \textsc{(App)},
the type $\mathsf{T}_2$ of the argument is less than the return type $\mathsf{T}_1$ of the function and the type of the 
whole expression is the the return type $\mathsf{T}_1$ of the function.


	
%$$
%\begin{array}{c}
%\texttt{+} : \Pi u_1:\texttt{int}. \Pi p_1:\texttt{int}.\Pi u_2:\texttt{int}. \Pi p_2:\texttt{int}.\\
%\quad\F{s_1}{u_1}{p_1}\rightarrow\F{s_2}{u_2}{p_2}\rightarrow\F{??}{u_1+u_2+1}{u_1+u_2+1-\max\big(\mathtt{u_1}-\mathtt{p_1},\mathtt{u_2}-\mathtt{p_2}\big)
%-\iota\big(\mathtt{u_1}-\mathtt{p_1},\mathtt{u_2}-\mathtt{p_2}\big)
%}
%\end{array}
%$$

\begin{figure}[tb]
\hrule			
$$\small
\begin{array}{c}
\ast\in\{ +,-,\times,\div\}\\
\\
\mathtt{\ast} : \Pi \mathtt{s_1}:\texttt{int},\mathtt{u_1}:\texttt{int}, \mathtt{p_1}:\texttt{int},\mathtt{s_2}:\texttt{int}, \mathtt{u_2}:\texttt{int}, \mathtt{p_2}:\texttt{int}.\\
\hspace{0.8cm}\F{s_1}{u_1}{p_1}\rightarrow\F{s_2}{u_2}{p_2}\\
\hspace{3.2cm}
\rightarrow\F{\mathcal{S}_\ast(\mathtt{s_1},\mathtt{s_2})}
{\mathcal{U}_\ast(\mathtt{s_1},\mathtt{u_1},\mathtt{s_2},\mathtt{u_2})}
{\mathcal{P}_\ast(\mathtt{u_1},\mathtt{p_1},\mathtt{u_2},\mathtt{p_2})}
\end{array}
$$
\scriptsize
$$
\begin{array}{rcl}
\mathcal{U}_+(\mathtt{s_1},\mathtt{u_1},\mathtt{s_2},\mathtt{u_2}))&=&\max(\mathtt{u_1},\mathtt{u_2})+\sigma_+(\mathtt{u_1},\mathtt{u_2})\\
\mathcal{P}_+(\mathtt{u_1},\mathtt{p_1},\mathtt{u_2},\mathtt{p_2}) &=&\max(\mathtt{u_1},\mathtt{u_2})+1-
   \max(\mathtt{u_1}-\mathtt{p_1},\mathtt{u_2}-\mathtt{p_2})-\iota(\mathtt{u_1}-\mathtt{p_1},\mathtt{u_2}-\mathtt{p_2})\\
   \\
\mathcal{U}_-(\mathtt{s_1},\mathtt{u_1},\mathtt{s_2},\mathtt{u_2})) &=&\max(\mathtt{u_1},\mathtt{u_2})+\sigma_-(\mathtt{u_1},\mathtt{u_2})\\
\mathcal{P}_-(\mathtt{u_1},\mathtt{p_1},\mathtt{u_2},\mathtt{p_2}) &=&\mathcal{P}_+(\mathtt{u_1},\mathtt{p_1},\mathtt{u_2},\mathtt{p_2})\\
\\
\mathcal{U}_\times(\mathtt{s_1},\mathtt{u_1},\mathtt{s_2},\mathtt{u_2}))&=&\mathtt{u_1}+\mathtt{u_2}+1\\
\mathcal{P}_\times(\mathtt{u_1},\mathtt{p_1},\mathtt{u_2},\mathtt{p_2})&=&
\mathtt{u_1}+\mathtt{u_2}+1-
\max(
\mathtt{u_1}+\mathtt{u_2}+1-\mathtt{p_1},
\mathtt{u_1}+\mathtt{u_2}+1-\mathtt{p_2})-\iota(\mathtt{p_1},\mathtt{p_2})\\
\\
\mathcal{U}_\div(\mathtt{s_1},\mathtt{u_1},\mathtt{s_2},\mathtt{u_2}))&=&\mathtt{u_1}-\mathtt{u_2}+1\\
\mathcal{P}_\div(\mathtt{u_1},\mathtt{p_1},\mathtt{u_2},\mathtt{p_2})&=&\mathcal{P}_\times(\mathtt{u_1},\mathtt{p_1},\mathtt{u_2},\mathtt{p_2})
\end{array}
$$
\tiny
$$
\begin{array}{ccc}
\mathcal{S}_+&&\mathcal{S}_-
\\
\begin{array}{c|c|c|c|c}
 \mathtt{s_1} \backslash \mathtt{s_2}
      &\quad 0 \quad& + & - & \quad\top\quad \\
\hline	  
\begin{array}{c}
\\ 0\\ \\
\end{array}    & 0 & + & - & \top \\
\hline
+    & + & + & 
\begin{array}{c}
+ \ \text{if}\ \mathtt{u_1}<\mathtt{u_2}\\
- \ \text{if}\ \mathtt{u_2}<\mathtt{u_1}\\
\top\ \text{otherwise}
\end{array}&\top\\
\hline
-     & - & 
\begin{array}{c}
+ \ \text{if}\ \mathtt{u_2}<\mathtt{u_1}\\
- \ \text{if}\ \mathtt{u_1}<\mathtt{u_2}\\
\top\ \text{otherwise}
\end{array}
 & - &\top\\
\hline
\begin{array}{c}
\\ \top\\ \\
\end{array} &\top &\top&\top&\top
\end{array}
&\hspace{1cm}&
\begin{array}{c|c|c|c|c}
 \mathtt{s_1} \backslash \mathtt{s_2}
      &\quad 0 \quad& + & - & \quad\top\quad \\
\hline	  
\begin{array}{c}
\\ 0\\ \\
\end{array}    & 0 & - & + & \top \\
\hline
+    & + &  
\begin{array}{c}
- \ \text{if}\ \mathtt{u_1}<\mathtt{u_2}\\
+ \ \text{if}\ \mathtt{u_2}<\mathtt{u_1}\\
\top\ \text{otherwise}
\end{array}& +&\top\\
\hline
-     & - & - &
\begin{array}{c}
- \ \text{if}\ \mathtt{u_2}<\mathtt{u_1}\\
+ \ \text{if}\ \mathtt{u_1}<\mathtt{u_2}\\
\top\ \text{otherwise}
\end{array}
  &\top\\
\hline
\begin{array}{c}
\\ \top\\ \\
\end{array} &\top &\top&\top&\top
\end{array}
 \end{array}
 $$
 $$
 \begin{array}{ccc}
\mathcal{S}_\times&&
\\
\begin{array}{c|c|c|c|c}
 \mathtt{s_1} \backslash \mathtt{s_2}
      &\quad 0 \quad& \quad+\quad & \quad-\quad & \quad\top\quad \\
\hline	  
\begin{array}{c}
\\ 0\\ \\
\end{array}    & 0 & 0 & 0 & 0 \\
\hline
\begin{array}{c}
\\ +\\ \\
\end{array}    & 0 &  + & - &\top\\
\hline
\begin{array}{c}
\\ -\\ \\
\end{array}    & 0 & - & +  &\top\\
\hline
\begin{array}{c}
\\ \top\\ \\
\end{array} &0 &\top&\top&\top
\end{array}
&\hspace{1cm}&
\begin{array}{cc}
\sigma_+&
\begin{array}{c|cccc}
  & 0 & + & - & \top \\
  \hline
0& 0 & 0  & 0 & 0 \\
+& 0 & 1 & 0 & 1\\
-& 0 & 0 & 1 & 1\\
\top&0&1 & 1 &1 
\end{array}
\\
&\\
\sigma_- &
\begin{array}{c|cccc}
  & 0 & + & - & \top \\
  \hline
0& 0 & 0  & 0 & 0 \\
+& 0 & 0 & 1 & 1\\
-& 0 & 1 & 0 & 1\\
\top&0&1 & 1 &1 
\end{array}
\end{array}
\end{array}
$$
\hrule
\caption{\label{figtypprim}Types of floating-point arithmetic operators.} 
\end{figure}


\normalsize



